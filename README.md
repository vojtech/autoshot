# Screenshot Test Automator

This project provides a set of tools to automate the generation and execution of screenshot tests for Android Compose applications. It consists of a KSP processor that generates test entry points from `@Preview` annotations and a set of Gradle convention plugins to simplify the setup.

## Components

*   **Processor (`:processor`)**: A KSP processor that scans for `@Preview` (and meta-annotated) Composable functions and generates a corresponding screenshot test file.
*   **Build Logic (`build-logic`)**: A set of Gradle convention plugins to manage build configuration and apply the screenshot testing infrastructure.
    *   `com.fediim.plugin.autoshot`: The main plugin that sets up KSP, the processor, and the test execution tasks.
    *   `com.fediim.android.application`, `com.fediim.android.library`, etc.: Helper plugins for standard Android setups.

## Publishing

To use these tools in your project (or locally within this repo), you first need to publish them to your local Maven repository.

We provide a `Makefile` to simplify this process.

### Publish Everything
```bash
make publish-all
```

### Publish Only Plugins
```bash
make publish-plugins
```

### Publish Only Processor
```bash
make publish-processor
```

## Usage

### 1. Configure Plugin Repositories (settings.gradle.kts)

To find the locally published plugin, you must add `mavenLocal()` to your `pluginManagement` block in `settings.gradle.kts`:

```kotlin
pluginManagement {
    repositories {
        mavenLocal() // Add this!
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
```

### 2. Enable Experimental Screenshot Testing (gradle.properties)

The Android Screenshot Testing plugin requires an experimental flag. Add this to your `gradle.properties`:

```properties
android.experimental.enableScreenshotTest=true
```

### 3. Configure Version Catalog (libs.versions.toml)

Add the plugin and the screenshot library to your `gradle/libs.versions.toml` file:

```toml
[versions]
screenshot = "0.0.1-alpha12"

[libraries]
screenshot = { id = "com.android.compose.screenshot", version.ref = "screenshot" }

[plugins]
screenshot = { id = "com.android.compose.screenshot", version.ref = "screenshot" }
fediim-screenshot = { id = "com.fediim.plugin.autoshot", version = "1.0.0-alpha01" }
```

### 4. Apply the Screenshot Plugin in Root build.gradle.kts

In your root `build.gradle.kts`, apply the screenshot plugin (but don't activate it):

```kotlin
plugins {
    alias(libs.plugins.screenshot) apply false
}
```

### 5. Apply the Plugin in Your Module

In your module's `build.gradle.kts` (e.g., `feature/build.gradle.kts`), apply the screenshot plugin. This plugin automatically handles the KSP setup and dependencies.

**Using Version Catalog (Recommended):**
```kotlin
plugins {
    // ... other plugins
    alias(libs.plugins.fediim.screenshot)
}
```

**Using ID directly:**
```kotlin
plugins {
    id("com.fediim.plugin.autoshot") version "1.0.0-alpha01"
}
```

### 6. Annotate Your Composables

The processor looks for any function annotated with `@Preview` or any annotation that is itself annotated with `@Preview` (meta-annotations like `@PreviewLightDark`).

**Important:** Preview functions must not be private so they can be accessed from the `screenshotTest` source set. To exclude a Preview from testing, you can either:
*   Make the preview function `private`
*   Use the `@IgnorePreview` annotation

```kotlin
@Composable
@PreviewLightDark
fun MyComposablePreview() {
    MyTheme {
        MyComposable()
    }
}

// This preview will be ignored
@Composable
@Preview
@IgnorePreview
fun MyComposablePreviewIgnored() {
    MyTheme {
        MyComposable()
    }
}

// This preview will also be ignored (private)
@Composable
@Preview
private fun MyComposablePreviewPrivate() {
    MyTheme {
        MyComposable()
    }
}
```

### 7. Run Screenshot Tests

The plugin registers a task to run the tests. Since this setup uses the Android Screenshot Testing library, you typically run:

```bash
./gradlew :<module>:screenshotDebug
```
*(Note: The exact task name depends on the Android Screenshot plugin integration. The convention plugin currently sets up the infrastructure to copy generated tests to `src/screenshotTest/kotlin`)*.

The generated tests will be located in `src/screenshotTest/kotlin` and will look like:

```kotlin
// Generated by ScreenshotProcessor
package com.example.feature

import androidx.compose.runtime.Composable
import androidx.compose.ui.tooling.preview.Preview
import com.fediim.automator.annotation.PreviewTest

@Preview
@PreviewTest
@Composable
fun MyComposablePreviewScreenshotTest() {
    MyComposablePreview()
}
```

## Configuration

The processor is configured to exclude files in `/generated/`, `/test/`, `/androidTest/`, and `/screenshotTest/` to prevent infinite recursion.

The convention plugin automatically copies the generated KSP files to `src/screenshotTest/kotlin` so they are picked up by the screenshot testing source set.
